# IA Raspberry Pi - Captura e Sincronização de Faces

Este projeto captura imagens de detecções faciais com OpenCV no Raspberry Pi (ou PC), armazena localmente em SQLite e sincroniza periodicamente com uma tabela `captures` no Supabase. Inclui mecanismos de resiliência: se o envio em lote falhar, os registros são enviados individualmente; os registros enviados com sucesso são removidos do SQLite local para evitar duplicidades.

Importante: o painel web `gerenciador.html` não é parte deste repositório por decisão do autor (evita expor chaves embutidas no HTML). O backend funciona de forma independente.

## Conteúdo do Repositório
- `capture_faces.py`: Script principal: captura de câmera, detecção com Haar Cascade, persistência (SQLite) e sincronização com Supabase.
- `requirements.txt`: Dependências Python do projeto.
- `supabase_setup.sql`: Script opcional para criar a tabela `captures` e permissões (RLS) no Supabase.
- `.gitignore`: Ignora caches, ambientes virtuais, banco local, exports e arquivos com segredos.

## Requisitos
- Python 3.9+ (recomendado)
- OpenCV (instalado via pip) e pacotes do `requirements.txt`
- Uma instância Supabase com tabela `captures`
- Acesso a uma câmera (USB, CSI, ou webcam do PC)

## Variáveis de Ambiente
Configure as credenciais do Supabase via variáveis de ambiente antes de rodar o script:
- `SUPABASE_URL`: URL do seu projeto Supabase (ex.: `https://xxxx.supabase.co`).
- `SUPABASE_ANON_KEY`: Chave Anon pública do Supabase.
- `DEVICE_ID`: Identificador do dispositivo (ex.: `raspi-01`).

Exemplos:
- PowerShell (Windows):
  - `$env:SUPABASE_URL = "https://xxxx.supabase.co"`
  - `$env:SUPABASE_ANON_KEY = "SEU_ANON_KEY"`
  - `$env:DEVICE_ID = "raspi-01"`
- bash (Linux/Raspberry Pi):
  - `export SUPABASE_URL="https://xxxx.supabase.co"`
  - `export SUPABASE_ANON_KEY="SEU_ANON_KEY"`
  - `export DEVICE_ID="raspi-01"`

Dica: Não commitar arquivos `.env`. Use o gerenciador de segredos do seu ambiente.

## Instalação (PC ou Raspberry Pi)
1. Crie e ative um ambiente virtual
   - Windows (PowerShell): `python -m venv .venv; .\.venv\\Scripts\\Activate.ps1`
   - Linux/RPi (bash): `python3 -m venv .venv && source .venv/bin/activate`
2. Instale dependências
   - `pip install -r requirements.txt`
3. (RPi) Dependências do sistema recomendadas
   - `sudo apt update && sudo apt install -y libatlas-base-dev libjpeg-dev libtiff5 libjasper1 libpng-dev`

## Execução
- Rodar detecção e captura:
  - `python capture_faces.py`
- Parâmetros úteis (ajuste no código conforme necessário):
  - Índice da câmera (0 padrão)
  - Intervalos de sincronização
  - Caminho do Haar Cascade (usa o embutido do OpenCV por padrão)

O script cria/usa um banco SQLite local (faces.db) e realiza sincronização com Supabase periodicamente.

## Estrutura da Tabela (Supabase)
A tabela `captures` deve conter (exemplo simplificado):
- `id` (bigint, PK, generated by identity)
- `created_at` (timestamp, default now())
- `date` (date)
- `time` (time)
- `device_id` (text)
- `image_base64` (text)

Veja `supabase_setup.sql` para detalhes e políticas RLS de exemplo.

## Sincronização e Resiliência
- Envio em lote: tenta inserir múltiplas capturas em uma única chamada.
- Fallback automático: em caso de falha no lote, envia item a item; os itens enviados com sucesso são removidos do SQLite local.
- Limpeza local: após sincronização bem-sucedida, remove capturas já enviadas do banco local.

## Exportação e Painel Web
O arquivo `gerenciador.html` (painel de visualização/gestão) é mantido fora do repositório. Caso deseje utilizá-lo localmente, duplique o arquivo e configure as chaves diretamente no HTML, ou adapte para ler de variáveis de ambiente do seu servidor/host. Não publique chaves sensíveis.

## Problemas Comuns
- Câmera não abre: verifique o índice da câmera e permissões do SO.
- Erros de dependência no RPi: instale bibliotecas do sistema listadas acima e garanta espaço em disco.
- 400 (Bad Request) no DELETE em massa (Supabase/PostgREST): sempre utilize um filtro explícito no DELETE (ex.: `id=not.is.null`) para evitar bloqueio de operação.

## Licença
Uso interno/educacional. Ajuste conforme necessidade.